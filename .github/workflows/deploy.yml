name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì‹¤ì œ ê²½ë¡œë¡œ ë³€ê²½ í•„ìš”)
            cd ${{ secrets.EC2_PROJECT_PATH || '~/pulluprn' }}
            
            # Gitì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Git pull..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            # Docker Composeë¡œ ì¬ì‹œì‘
            echo "ğŸ”„ Docker Compose ì¬ì‹œì‘..."
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ! ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker-compose ps
            
            # ìµœê·¼ ë¡œê·¸ í™•ì¸ (ì—ëŸ¬ ì²´í¬ìš©)
            echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
            docker-compose logs --tail=50
