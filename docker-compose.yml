version: '3.8'

# 로그 용량 제한 (EC2 디스크 부족 방지를 위한 필수 설정)
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # 1. 프론트엔드: Next.js (Standalone 빌드)
  client:
    build: ./client
    container_name: pulluprn-client
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      # NextAuth 및 OAuth 인증 관련
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      # 앱 로직 및 소켓 통신 관련
      - TEST_ACCESS_CODE=${TEST_ACCESS_CODE}
      - NEXT_PUBLIC_SOCKET_URL=${NEXT_PUBLIC_SOCKET_URL}
      - NEXT_PUBLIC_VIDEO_SOCKET_URL=${NEXT_PUBLIC_VIDEO_SOCKET_URL}
    logging: *default-logging
    depends_on:
      db:
        condition: service_healthy

  # 2. 백엔드: 채팅 서버 (Socket.IO)
  server-chat:
    build: ./server
    container_name: pulluprn-chat
    restart: always
    ports:
      - "3001:3001"
    # 시작 시 Prisma 마이그레이션을 실행한 뒤 서버를 띄웁니다.
    command: sh -c "npx prisma migrate deploy && node chat.js"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - CORS_ORIGIN=${CORS_ORIGIN}
    logging: *default-logging
    depends_on:
      db:
        condition: service_healthy

  # 3. 백엔드: 화상 통화 서버
  server-video:
    build: ./server
    container_name: pulluprn-video
    restart: always
    ports:
      - "3002:3002"
    command: node videocall.js
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - VIDEOCALL_PORT=${VIDEOCALL_PORT:-3002}
      - CORS_ORIGIN=${CORS_ORIGIN}
    logging: *default-logging
    depends_on:
      db:
        condition: service_healthy

  # 4. 데이터베이스: PostgreSQL
  db:
    image: postgres:17-alpine
    container_name: pulluprn-db
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "127.0.0.1:5432:5432" # 보안을 위해 EC2 내부에서만 접속 허용
    volumes:
      - pulluprn_db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 5s
      timeout: 5s
      retries: 5
    logging: *default-logging

volumes:
  pulluprn_db_data:
